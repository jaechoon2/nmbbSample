{"ts":1357871848485,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"module.exports = function(app, models) {\n  var io = require('socket.io');\n  var utils = require('connect').utils;\n  var cookie = require('cookie');\n  var Session = require('connect').middleware.session.Session;\n\n  var sio = io.listen(app.server)\n\n  sio.configure(function() {\n    app.isAccountOnline = function(accountId) {\n      var clients = sio.sockets.clients(accountId);\n      return (clients.length > 0);\n    };\n\n    sio.set('authorization', function( data, accept) {\n      var signedCookies = cookie.parse(data.headers.cookie);\n      var cookies = utils.parseSignedCookies(signedCookies,app.sessionSecret);\n      data.sessionID = cookies['express.sid'];\n      data.sessionStore = app.sessionStore;\n      data.sessionStore.get(data.sessionID, function(err, session) {\n        if ( err || !session ) {\n          return accept('Invalid session', false);\n        } else {\n          data.session = new Session(data, session);\n          accept(null, true);\n        }\n      });\n    });\n\n    sio.sockets.on('connection', function(socket) {\n      var session = socket.handshake.session;\n      var accountId = session.accountId;\n      var sAccount = null;\n      socket.join(accountId);\n\n      app.triggerEvent('event:' + accountId, {\n        from: accountId,\n        action: 'login'\n      });\n\n      var handleContactEvent = function(eventMessage) {\n        socket.emit('contactEvent', eventMessage);\n      };\n\n      var subscribeToAccount = function(accountId) {\n        var eventName = 'event:' + accountId;\n        app.addEventListener(eventName, handleContactEvent);\n        console.log('Subscribing to ' + eventName);\n      };\n\n      models.Account.findById(accountId, function subscribeToFriendFeeds(account) {\n        var subscribedAccounts = {};\n        sAccount = account;\n        account.contacts.forEach(function(contact) {\n          if ( !subscribedAccounts[contact.accountId]) {\n            subscribeToAccount(contact.accountId);\n            subscribedAccounts[contact.accountId] = true;\n          }\n        });\n\n        if (!subscribedAccounts[accountId]) {\n          // Subscribe to my own updates\n          subscribeToAccount(accountId);\n        }\n      });\n\n      socket.on('disconnect', function() {\n        sAccount.contacts.forEach(function(contact) {\n          var eventName = 'event:' + contact.accountId;\n          app.removeEventListener(eventName, handleContactEvent);\n          console.log('Unsubscribing from ' + eventName);\n        });\n        app.triggerEvent('event:' + accountId, {\n          from: accountId,\n          action: 'logout'\n        });\n      });\n\n      socket.on('chatclient', function(data) {\n        sio.sockets.in(data.to).emit('chatserver', {\n          from: accountId,\n          text: data.text\n        });\n      });\n    });\n  });\n}"]],"start1":0,"start2":0,"length1":0,"length2":2777}]],"length":2777}
{"contributors":[],"silentsave":false,"ts":1357871875984,"patch":[[{"diffs":[[0,"\n\n  var "],[-1,"s"],[0,"io = io."]],"start1":210,"start2":210,"length1":17,"length2":16}]],"length":2776,"saved":false}
{"contributors":[],"silentsave":false,"ts":1357871933657,"patch":[[{"diffs":[[0,"ion;\n\n  var "],[1,"s"],[0,"io = io.list"]],"start1":206,"start2":206,"length1":24,"length2":25},{"diffs":[[0,".server)"],[1,";"],[0,"\n\n  sio."]],"start1":237,"start2":237,"length1":16,"length2":17}]],"length":2778,"saved":false}
{"contributors":[],"silentsave":false,"ts":1358110756139,"patch":[[{"diffs":[[0,"dels) {\n"],[1,"  "],[0,"  var io"]],"start1":33,"start2":33,"length1":16,"length2":18},{"diffs":[[0,"ocket.io');\n"],[1,"  "],[0,"  var utils "]],"start1":64,"start2":64,"length1":24,"length2":26},{"diffs":[[0,"').utils;\n  "],[1," "],[1," "],[0,"var cookie ="]],"start1":108,"start2":108,"length1":24,"length2":26},{"diffs":[[0,"okie');\n"],[1,"  "],[0,"  var Se"]],"start1":146,"start2":146,"length1":16,"length2":18},{"diffs":[[0,"ion;\n\n  "],[1," "],[1," "],[0,"var sio "]],"start1":214,"start2":214,"length1":16,"length2":18},{"diffs":[[0,"rver);\n\n"],[1,"  "],[0,"  sio.co"]],"start1":250,"start2":250,"length1":16,"length2":18},{"diffs":[[0,"ion() {\n    "],[1,"  "],[1,"  "],[0,"app.isAccoun"]],"start1":281,"start2":281,"length1":24,"length2":28},{"diffs":[[0,"Id) {\n      "],[1,"  "],[1,"    "],[0,"var clients "]],"start1":335,"start2":335,"length1":24,"length2":30},{"diffs":[[0,"tId);\n      "],[1,"     "],[1," "],[0,"return (clie"]],"start1":393,"start2":393,"length1":24,"length2":30},{"diffs":[[0,"h > 0);\n"],[1,"    "],[0,"    };\n\n"]],"start1":432,"start2":432,"length1":16,"length2":20},{"diffs":[[0,"    };\n\n    "],[1,"   "],[1," "],[0,"sio.set('aut"]],"start1":444,"start2":444,"length1":24,"length2":28},{"diffs":[[0,"unction("],[-1," "],[0,"data, ac"]],"start1":486,"start2":486,"length1":17,"length2":16},{"diffs":[[0,", accept) {\n"],[1,"      "],[0,"      var si"]],"start1":498,"start2":498,"length1":24,"length2":30},{"diffs":[[0,"kie);\n      "],[1," "],[1,"     "],[0,"var cookies "]],"start1":571,"start2":571,"length1":24,"length2":30},{"diffs":[[0,"Cookies,"],[1," "],[0,"app.sess"]],"start1":634,"start2":634,"length1":16,"length2":17},{"diffs":[[0,"nSecret);\n      "],[1,"   "],[1,"   "],[0,"data.sessionID ="]],"start1":653,"start2":653,"length1":32,"length2":38},{"diffs":[[0,".sid'];\n"],[1,"      "],[0,"      da"]],"start1":708,"start2":708,"length1":16,"length2":22},{"diffs":[[0,"nStore;\n"],[1,"      "],[0,"      da"]],"start1":758,"start2":758,"length1":16,"length2":22},{"diffs":[[0,"        "],[1,"  "],[1,"      "],[0,"if ("],[-1," "],[0,"err || !"]],"start1":841,"start2":841,"length1":21,"length2":28},{"diffs":[[0,"sion"],[-1," "],[0,") {\n"],[1,"          "],[0,"    "]],"start1":872,"start2":872,"length1":13,"length2":22},{"diffs":[[0,"    "],[-1,"} else {\n"],[1,"        }\n                else {\n          "],[0,"    "]],"start1":945,"start2":945,"length1":17,"length2":51},{"diffs":[[0,"ssion);\n"],[1,"          "],[0,"        "]],"start1":1037,"start2":1037,"length1":16,"length2":26},{"diffs":[[0," true);\n        "],[1,"       "],[1," "],[0,"}\n"],[1,"      "],[0,"      });\n    })"]],"start1":1077,"start2":1077,"length1":34,"length2":48},{"diffs":[[0,"    });\n    "],[1," "],[1,"   "],[0,"});\n\n"],[1,"    "],[0,"    sio.sock"]],"start1":1111,"start2":1111,"length1":29,"length2":37},{"diffs":[[0,"et) {\n      "],[1,"   "],[1,"   "],[0,"var session "]],"start1":1182,"start2":1182,"length1":24,"length2":30},{"diffs":[[0,"ession;\n"],[1,"      "],[0,"      va"]],"start1":1232,"start2":1232,"length1":16,"length2":22},{"diffs":[[0,".accountId;\n"],[1,"      "],[0,"      var sA"]],"start1":1275,"start2":1275,"length1":24,"length2":30},{"diffs":[[0,"null;\n      "],[1,"  "],[1,"    "],[0,"socket.join("]],"start1":1314,"start2":1314,"length1":24,"length2":30},{"diffs":[[0,"ccountId);\n\n"],[1,"      "],[0,"      app.tr"]],"start1":1345,"start2":1345,"length1":24,"length2":30},{"diffs":[[0,"ntId, {\n        "],[1,"       "],[1," "],[0,"from: accountId,"]],"start1":1402,"start2":1402,"length1":32,"length2":40},{"diffs":[[0,"rom: accountId,\n"],[1,"        "],[0,"        action: "]],"start1":1427,"start2":1427,"length1":32,"length2":40},{"diffs":[[0,"'login'\n"],[1,"      "],[0,"      })"]],"start1":1467,"start2":1467,"length1":16,"length2":22},{"diffs":[[0," });\n\n      "],[1,"  "],[1,"    "],[0,"var handleCo"]],"start1":1486,"start2":1486,"length1":24,"length2":30},{"diffs":[[0,") {\n        "],[1,"     "],[1,"   "],[0,"socket.emit("]],"start1":1550,"start2":1550,"length1":24,"length2":32},{"diffs":[[0,"ntMessage);\n"],[1,"      "],[0,"      };\n\n  "]],"start1":1601,"start2":1601,"length1":24,"length2":30},{"diffs":[[0,"        };\n\n"],[1,"      "],[0,"      var su"]],"start1":1617,"start2":1617,"length1":24,"length2":30},{"diffs":[[0,"on(accountId) {\n"],[1,"        "],[0,"        var even"]],"start1":1672,"start2":1672,"length1":32,"length2":40},{"diffs":[[0,"Id;\n        "],[1,"   "],[1,"     "],[0,"app.addEvent"]],"start1":1738,"start2":1738,"length1":24,"length2":32},{"diffs":[[0,"eContactEvent);\n"],[1,"        "],[0,"        console."]],"start1":1795,"start2":1795,"length1":32,"length2":40},{"diffs":[[0,"ame);\n      "],[1,"    "],[1,"  "],[0,"};\n\n"],[1,"      "],[0,"      models"]],"start1":1865,"start2":1865,"length1":28,"length2":40},{"diffs":[[0,"(account) {\n"],[1,"        "],[0,"        var "]],"start1":1965,"start2":1965,"length1":24,"length2":32},{"diffs":[[0,"s = {};\n        "],[1," "],[1,"       "],[0,"sAccount = accou"]],"start1":2014,"start2":2014,"length1":32,"length2":40},{"diffs":[[0,"ccount;\n"],[1,"        "],[0,"        "]],"start1":2050,"start2":2050,"length1":16,"length2":24},{"diffs":[[0,"    "],[1,"   "],[1,"       "],[0,"if ("],[-1," "],[0,"!sub"]],"start1":2125,"start2":2125,"length1":13,"length2":22},{"diffs":[[0,") {\n            "],[1,"         "],[1,"   "],[0,"subscribeToAccou"]],"start1":2181,"start2":2181,"length1":32,"length2":44},{"diffs":[[0,"act.accountId);\n"],[1,"            "],[0,"            subs"]],"start1":2232,"start2":2232,"length1":32,"length2":44},{"diffs":[[0,"true;\n          "],[1,"  "],[1,"        "],[0,"}\n        });\n\n "]],"start1":2312,"start2":2312,"length1":32,"length2":42},{"diffs":[[0,"      }\n        "],[1," "],[1,"       "],[0,"});\n\n        if "]],"start1":2332,"start2":2332,"length1":32,"length2":40},{"diffs":[[0,"   });\n\n        "],[1," "],[1,"       "],[0,"if (!subscribedA"]],"start1":2353,"start2":2353,"length1":32,"length2":40},{"diffs":[[0,"        "],[1,"  "],[1,"        "],[0,"// Subsc"]],"start1":2417,"start2":2417,"length1":16,"length2":26},{"diffs":[[0,"dates\n          "],[1," "],[1,"         "],[0,"subscribeToAccou"]],"start1":2460,"start2":2460,"length1":32,"length2":42},{"diffs":[[0,"unt(accountId);\n"],[1,"        "],[0,"        }\n      "]],"start1":2501,"start2":2501,"length1":32,"length2":40},{"diffs":[[0,"    }\n      "],[-1,"});\n\n"],[1,"      });\n\n      "],[0,"      socket"]],"start1":2529,"start2":2529,"length1":29,"length2":41},{"diffs":[[0,"ion() {\n        "],[1,"     "],[1,"   "],[0,"sAccount.contact"]],"start1":2593,"start2":2593,"length1":32,"length2":40},{"diffs":[[0,"ct) {\n          "],[1,"      "],[1,"    "],[0,"var eventName = "]],"start1":2657,"start2":2657,"length1":32,"length2":42},{"diffs":[[0,";\n          "],[1,"    "],[1,"      "],[0,"app.removeEv"]],"start1":2727,"start2":2727,"length1":24,"length2":34},{"diffs":[[0,"eContactEvent);\n"],[1,"          "],[0,"          consol"]],"start1":2789,"start2":2789,"length1":32,"length2":42},{"diffs":[[0,"tName);\n        "],[1,"  "],[-1,"});\n"],[1,"      });\n        "],[0,"        app.trig"]],"start1":2865,"start2":2865,"length1":36,"length2":52},{"diffs":[[0,"Id, {\n          "],[1,"   "],[1,"       "],[0,"from: accountId,"]],"start1":2944,"start2":2944,"length1":32,"length2":42},{"diffs":[[0,"rom: accountId,\n"],[1,"          "],[0,"          action"]],"start1":2971,"start2":2971,"length1":32,"length2":42},{"diffs":[[0,"logout'\n"],[1,"        "],[0,"        "]],"start1":3016,"start2":3016,"length1":16,"length2":24},{"diffs":[[0,"  });\n      "],[1," "],[1,"     "],[0,"});\n\n      s"]],"start1":3038,"start2":3038,"length1":24,"length2":30},{"diffs":[[0," });\n\n      "],[1,"   "],[1,"   "],[0,"socket.on('c"]],"start1":3055,"start2":3055,"length1":24,"length2":30},{"diffs":[[0,"data) {\n        "],[1,"      "],[1,"  "],[0,"sio.sockets.in(d"]],"start1":3106,"start2":3106,"length1":32,"length2":40},{"diffs":[[0,"sockets."],[1," "],[0,"in"],[1," "],[0,"(data.to"]],"start1":3134,"start2":3134,"length1":18,"length2":20},{"diffs":[[0,"r', {\n          "],[1,"     "],[1,"     "],[0,"from: accountId,"]],"start1":3171,"start2":3171,"length1":32,"length2":42},{"diffs":[[0,"        "],[1,"    "],[1,"      "],[0,"text: da"]],"start1":3216,"start2":3216,"length1":16,"length2":26},{"diffs":[[0,"ta.text\n"],[1,"                });\n            });\n"],[0,"        "]],"start1":3242,"start2":3242,"length1":16,"length2":52},{"diffs":[[0,"});\n"],[-1,"      });\n"],[0,"    });\n"],[-1,"  });\n"],[0,"}"],[1,";"]],"start1":3294,"start2":3294,"length1":29,"length2":14}]],"length":3308,"saved":false}
