{"ts":1357870973229,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"module.exports = function(app, models) {\n  app.get('/accounts/:id/contacts', function(req, res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    models.Account.findById(accountId, function(account) {\n      res.send(account.contacts);\n    });\n  });\n  \n  app.get('/accounts/:id/activity', function(req, res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    models.Account.findById(accountId, function(account) {\n      res.send(account.activity);\n    });\n  });\n  \n  app.get('/accounts/:id/status', function(req, res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    models.Account.findById(accountId, function(account) {\n      res.send(account.status);\n    });\n  }); \n  \n  app.post('/accounts/:id/status', function(req, res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    models.Account.findById(accountId, function(account) {\n      var status = {\n        name: account.name,\n        status: req.param('status', '')\n      };\n      account.status.push(status);  \n  \n      // Push the status to all friends\n      account.activity.push(status);\n      account.save(function (err) {\n        if (err) {\n          console.log('Error saving account: ' + err);\n        } else {\n          app.triggerEvent('event:' + accountId, {\n            from: accountId,\n            data: status,\n            action: 'status'\n          });\n        }\n      });\n    });\n    res.send(200);\n  });  \n \n  app.delete('/accounts/:id/contact', function(req,res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    var contactId = req.param('contactId', null);     \n  \n    // Missing contactId, don't bother going any further\n    if ( null === contactId ) {\n      res.send(400);\n      return;\n    }  \n \n    models.Account.findById(accountId, function(account) {\n      if ( !account ) return;\n      models.Account.findById(contactId, function(contact,err) {\n        if ( !contact ) return;  \n \n        models.Account.removeContact(account, contactId);\n        // Kill the reverse link\n        models.Account.removeContact(contact, accountId);\n      });\n    });\n \n    // Note: Not in callback - this endpoint returns immediately and\n    // processes in the background\n    res.send(200);\n  });\n \n  app.post('/accounts/:id/contact', function(req,res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    var contactId = req.param('contactId', null);\n   console.log(contactId + 'inside POST /accounts/:id/contact');\n    // Missing contactId, don't bother going any further\n    if ( null === contactId ) {\n      res.send(400);\n      return;\n    }\n  \n    models.Account.findById(accountId, function(account) {\n      if ( account ) {\n        models.Account.findById(contactId, function(contact) {\n          models.Account.addContact(account, contact);\n  \n          // Make the reverse link\n          models.Account.addContact(contact, account);\n          account.save();\n        });\n      }\n    });\n  \n    // Note: Not in callback - this endpoint returns immediately and\n    // processes in the background\n    res.send(200);\n  });\n  \n  app.get('/accounts/:id', function(req, res) {\n    var accountId = req.params.id == 'me'\n                       ? req.session.accountId\n                       : req.params.id;\n    models.Account.findById(accountId, function(account) {\n      if ( accountId == 'me' || models.Account.hasContact(account, req.session.accountId) ) {\n        account.isFriend = true;\n      }\n      res.send(account);\n    });\n  });\n}"]],"start1":0,"start2":0,"length1":0,"length2":3913}]],"length":3913}
{"contributors":[],"silentsave":false,"ts":1358104791835,"patch":[[{"diffs":[[0,"  });\n \n"],[1," // post contact\n"],[0,"  app.po"]],"start1":2579,"start2":2579,"length1":16,"length2":33},{"diffs":[[0,"log("],[-1,"contactId + "],[0,"'ins"]],"start1":2850,"start2":2850,"length1":20,"length2":8},{"diffs":[[0,"ccount) {\n      "],[1,"//"],[0,"if ( accountId ="]],"start1":3733,"start2":3733,"length1":32,"length2":34},{"diffs":[[0,"ountId) ) {\n"],[1,"      if ( req.params.id == 'me' || models.Account.hasContact(account, req.session.accountId) ) {\n"],[0,"        acco"]],"start1":3827,"start2":3827,"length1":24,"length2":122}]],"length":4018,"saved":false}
{"contributors":[],"silentsave":false,"ts":1358110553404,"patch":[[{"diffs":[[0,"dels) {\n"],[1,"  "],[0,"  app.ge"]],"start1":33,"start2":33,"length1":16,"length2":18},{"diffs":[[0,"ion(req, res) {\n"],[1,"    "],[0,"    var accountI"]],"start1":84,"start2":84,"length1":32,"length2":36},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":137,"start2":137,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":161,"start2":161,"length1":39,"length2":16},{"diffs":[[0," req.params.id;\n"],[1,"    "],[0,"    models.Accou"]],"start1":171,"start2":171,"length1":32,"length2":36},{"diffs":[[0,"tion(account) {\n"],[1,"      "],[0,"      res.send(a"]],"start1":234,"start2":234,"length1":32,"length2":38},{"diffs":[[0,"tacts);\n"],[1,"    "],[0,"    });\n"],[1,"  "],[0,"  });\n"],[1,"\n"],[0,"  "],[-1,"\n"],[0,"  app.ge"]],"start1":282,"start2":282,"length1":33,"length2":39},{"diffs":[[0,"ion(req, res) {\n"],[1,"    "],[0,"    var accountI"]],"start1":354,"start2":354,"length1":32,"length2":36},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":407,"start2":407,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":431,"start2":431,"length1":39,"length2":16},{"diffs":[[0," req.params.id;\n"],[1,"    "],[0,"    models.Accou"]],"start1":441,"start2":441,"length1":32,"length2":36},{"diffs":[[0,"ccount) {\n      "],[1,"      "],[0,"res.send(account"]],"start1":510,"start2":510,"length1":32,"length2":38},{"diffs":[[0,"    "],[1,"    "],[0,"});\n  "],[1,"  "],[0,"});\n"],[1,"\n"],[0,"  "],[-1,"\n"],[0,"  ap"]],"start1":560,"start2":560,"length1":21,"length2":27},{"diffs":[[0,"req, res) {\n    "],[1,"    "],[0,"var accountId = "]],"start1":626,"start2":626,"length1":32,"length2":36},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":675,"start2":675,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":699,"start2":699,"length1":39,"length2":16},{"diffs":[[0," req.params.id;\n"],[1,"    "],[0,"    models.Accou"]],"start1":709,"start2":709,"length1":32,"length2":36},{"diffs":[[0,"ccount) {\n      "],[1,"      "],[0,"res.send(account"]],"start1":778,"start2":778,"length1":32,"length2":38},{"diffs":[[0,"nt.status);\n"],[1,"    "],[0,"    });\n  })"]],"start1":814,"start2":814,"length1":24,"length2":28},{"diffs":[[0,";\n  "],[1,"  "],[0,"});"],[-1," "],[1,"\n"],[0,"\n  "],[-1,"\n"],[0,"  ap"]],"start1":836,"start2":836,"length1":16,"length2":17},{"diffs":[[0,"req, res) {\n    "],[1,"    "],[0,"var accountId = "]],"start1":893,"start2":893,"length1":32,"length2":36},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":942,"start2":942,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":966,"start2":966,"length1":39,"length2":16},{"diffs":[[0," req.params.id;\n"],[1,"    "],[0,"    models.Accou"]],"start1":976,"start2":976,"length1":32,"length2":36},{"diffs":[[0,"nt) {\n      "],[1,"      "],[0,"var status ="]],"start1":1049,"start2":1049,"length1":24,"length2":30},{"diffs":[[0,"        "],[1,"        "],[0,"name: ac"]],"start1":1082,"start2":1082,"length1":16,"length2":24},{"diffs":[[0,"        "],[1,"        "],[0,"status: "]],"start1":1118,"start2":1118,"length1":16,"length2":24},{"diffs":[[0,"    "],[-1,"};\n"],[1,"      };\n   "],[0,"      "],[1,"   "],[0,"acco"]],"start1":1168,"start2":1168,"length1":17,"length2":29},{"diffs":[[0,"us);"],[-1,"  \n  \n"],[1,"\n\n    "],[0,"      "],[1,"  "],[0,"// P"]],"start1":1217,"start2":1217,"length1":20,"length2":22},{"diffs":[[0,"iends\n      "],[1,"      "],[0,"account.acti"]],"start1":1263,"start2":1263,"length1":24,"length2":30},{"diffs":[[0,"sh(status);\n"],[1,"      "],[0,"      accoun"]],"start1":1300,"start2":1300,"length1":24,"length2":30},{"diffs":[[0,"function"],[-1," "],[0,"(err) {\n"]],"start1":1337,"start2":1337,"length1":17,"length2":16},{"diffs":[[0,") {\n        "],[1,"        "],[0,"if (err) {\n "]],"start1":1349,"start2":1349,"length1":24,"length2":32},{"diffs":[[0,"     if (err) {\n"],[1,"          "],[0,"          consol"]],"start1":1364,"start2":1364,"length1":32,"length2":42},{"diffs":[[0,"        "],[-1,"}"],[1,"        }\n               "],[0," else {\n"]],"start1":1445,"start2":1445,"length1":17,"length2":41},{"diffs":[[0,"{\n          "],[1,"          "],[0,"app.triggerE"]],"start1":1484,"start2":1484,"length1":24,"length2":34},{"diffs":[[0,"ntId, {\n"],[1,"            "],[0,"        "]],"start1":1539,"start2":1539,"length1":16,"length2":28},{"diffs":[[0,"        "],[1,"            "],[0,"data: st"]],"start1":1592,"start2":1592,"length1":16,"length2":28},{"diffs":[[0,"status,\n"],[1,"            "],[0,"        "]],"start1":1618,"start2":1618,"length1":16,"length2":28},{"diffs":[[0,"    "],[-1,"});\n        }\n"],[1,"          });\n                }\n   "],[0,"      "],[1,"   "],[0,"});\n"],[1,"    "],[0,"    });\n"],[1,"    "],[0,"    "]],"start1":1673,"start2":1673,"length1":40,"length2":72},{"diffs":[[0,"0);\n"],[1,"  "],[0,"  });"],[1,"\n\n"],[0,"  "],[-1,"\n \n"],[0,"  ap"]],"start1":1756,"start2":1756,"length1":18,"length2":19},{"diffs":[[0,"', function(req,"],[1," "],[0,"res) {\n    var a"]],"start1":1806,"start2":1806,"length1":32,"length2":33},{"diffs":[[0,"req, res) {\n    "],[1,"    "],[0,"var accountId = "]],"start1":1818,"start2":1818,"length1":32,"length2":36},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":1867,"start2":1867,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":1891,"start2":1891,"length1":39,"length2":16},{"diffs":[[0," req.params.id;\n"],[1,"    "],[0,"    var contactI"]],"start1":1901,"start2":1901,"length1":32,"length2":36},{"diffs":[[0,"ll);"],[1,"\n\n"],[0,"     "],[-1,"\n  \n "],[0,"   /"]],"start1":1966,"start2":1966,"length1":18,"length2":15},{"diffs":[[0,"any further\n"],[1,"    "],[0,"    if ("],[-1," "],[0,"null === con"]],"start1":2021,"start2":2021,"length1":33,"length2":36},{"diffs":[[0,"ll === contactId"],[-1," "],[0,") {\n      res.se"]],"start1":2047,"start2":2047,"length1":33,"length2":32},{"diffs":[[0,"tactId) {\n      "],[1,"      "],[0,"res.send(400);\n "]],"start1":2057,"start2":2057,"length1":32,"length2":38},{"diffs":[[0,"end(400);\n      "],[1,"      "],[0,"return;\n    }  \n"]],"start1":2084,"start2":2084,"length1":32,"length2":38},{"diffs":[[0,"    "],[-1,"}  \n \n"],[1,"    }\n\n    "],[0,"    "]],"start1":2114,"start2":2114,"length1":14,"length2":19},{"diffs":[[0,"tion(account) {\n"],[1,"      "],[0,"      if ( !acco"]],"start1":2172,"start2":2172,"length1":32,"length2":38},{"diffs":[[0,"if ("],[-1," "],[0,"!account"],[-1," "],[0,") re"]],"start1":2200,"start2":2200,"length1":18,"length2":16},{"diffs":[[0,"turn;\n      "],[1,"      "],[0,"models.Accou"]],"start1":2216,"start2":2216,"length1":24,"length2":30},{"diffs":[[0,"contact,"],[1," "],[0,"err) {\n"],[1,"        "],[0,"        "]],"start1":2278,"start2":2278,"length1":23,"length2":32},{"diffs":[[0,"if ("],[-1," "],[0,"!contact"],[-1," "],[0,") re"]],"start1":2310,"start2":2310,"length1":18,"length2":16},{"diffs":[[0,"urn;"],[-1,"  \n \n"],[1,"\n\n        "],[0,"    "]],"start1":2327,"start2":2327,"length1":13,"length2":18},{"diffs":[[0,"        "],[1,"        "],[0,"// Kill "]],"start1":2399,"start2":2399,"length1":16,"length2":24},{"diffs":[[0,"he reverse link\n"],[1,"        "],[0,"        models.A"]],"start1":2424,"start2":2424,"length1":32,"length2":40},{"diffs":[[0,"    "],[1,"      "],[0,"});\n    "],[1,"    "],[0,"});\n"],[-1," "],[0,"\n"],[1,"    "],[0,"    "]],"start1":2508,"start2":2508,"length1":22,"length2":35},{"diffs":[[0,"diately and\n    "],[1,"    "],[0,"// processes in "]],"start1":2596,"start2":2596,"length1":32,"length2":36},{"diffs":[[0," the background\n"],[1,"    "],[0,"    res.send(200"]],"start1":2631,"start2":2631,"length1":32,"length2":36},{"diffs":[[0,"0);\n"],[1,"  "],[0,"  });\n"],[-1," "],[0,"\n"],[1,"   "],[0," // "]],"start1":2666,"start2":2666,"length1":16,"length2":20},{"diffs":[[0,"contact\n"],[1,"  "],[0,"  app.po"]],"start1":2691,"start2":2691,"length1":16,"length2":18},{"diffs":[[0,"ion(req,"],[1," "],[0,"res) {\n"],[1,"    "],[0,"    var "]],"start1":2742,"start2":2742,"length1":23,"length2":28},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":2795,"start2":2795,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":2819,"start2":2819,"length1":39,"length2":16},{"diffs":[[0,"ams.id;\n    "],[1,"    "],[0,"var contactI"]],"start1":2837,"start2":2837,"length1":24,"length2":28},{"diffs":[[0," null);\n"],[1,"     "],[0,"   conso"]],"start1":2891,"start2":2891,"length1":16,"length2":21},{"diffs":[[0,"tact');\n"],[1,"    "],[0,"    // M"]],"start1":2949,"start2":2949,"length1":16,"length2":20},{"diffs":[[0,"her\n    "],[1,"    "],[0,"if ("],[-1," "],[0,"null ==="]],"start1":3014,"start2":3014,"length1":21,"length2":24},{"diffs":[[0,"ontactId"],[-1," "],[0,") {\n    "]],"start1":3040,"start2":3040,"length1":17,"length2":16},{"diffs":[[0,"Id) {\n      "],[1,"      "],[0,"res.send(400"]],"start1":3046,"start2":3046,"length1":24,"length2":30},{"diffs":[[0,"    "],[1,"      "],[0,"return;\n"],[1,"    "],[0,"    }\n"],[1,"\n"],[0,"  "],[-1,"\n"],[1,"  "],[0,"    "]],"start1":3081,"start2":3081,"length1":25,"length2":37},{"diffs":[[0,"    "],[1,"      "],[0,"if ("],[-1," "],[0,"account"],[-1," "],[0,") {\n"],[1,"        "],[0,"    "]],"start1":3175,"start2":3175,"length1":25,"length2":37},{"diffs":[[0,"ct) {\n          "],[1,"          "],[0,"models.Account.a"]],"start1":3265,"start2":3265,"length1":32,"length2":42},{"diffs":[[0,"ntact);\n"],[1,"\n     "],[0,"  "],[-1,"\n"],[0,"        "]],"start1":3328,"start2":3328,"length1":19,"length2":24},{"diffs":[[0,"            "],[1,"   "],[0,"// Make the "]],"start1":3342,"start2":3342,"length1":24,"length2":27},{"diffs":[[0,"he reverse link\n"],[1,"          "],[0,"          models"]],"start1":3366,"start2":3366,"length1":32,"length2":42},{"diffs":[[0,"unt);\n          "],[1,"          "],[0,"account.save();\n"]],"start1":3441,"start2":3441,"length1":32,"length2":42},{"diffs":[[0,"save();\n        "],[1,"        "],[0,"});\n      }\n    "]],"start1":3475,"start2":3475,"length1":32,"length2":40},{"diffs":[[0,"    "],[-1,"}\n"],[1,"      }\n    "],[0,"    });\n"],[1,"\n"],[0,"  "],[-1,"\n"],[1,"  "],[0,"    "]],"start1":3505,"start2":3505,"length1":21,"length2":33},{"diffs":[[0,"diately and\n"],[1,"    "],[0,"    // proce"]],"start1":3591,"start2":3591,"length1":24,"length2":28},{"diffs":[[0," background\n"],[1,"    "],[0,"    res.send"]],"start1":3630,"start2":3630,"length1":24,"length2":28},{"diffs":[[0,"0);\n"],[1,"  "],[0,"  });\n"],[1,"\n"],[0,"  "],[-1,"\n"],[0,"  ap"]],"start1":3661,"start2":3661,"length1":17,"length2":19},{"diffs":[[0,"req, res) {\n"],[1,"    "],[0,"    var acco"]],"start1":3712,"start2":3712,"length1":24,"length2":28},{"diffs":[[0," == 'me'"],[-1,"\n                      "],[0," ? req.s"]],"start1":3761,"start2":3761,"length1":39,"length2":16},{"diffs":[[0,"ccountId"],[-1,"\n                      "],[0," : req.p"]],"start1":3785,"start2":3785,"length1":39,"length2":16},{"diffs":[[0,".params.id;\n"],[1,"    "],[0,"    models.A"]],"start1":3799,"start2":3799,"length1":24,"length2":28},{"diffs":[[0,"(account) {\n"],[1,"      "],[0,"      //if ("]],"start1":3862,"start2":3862,"length1":24,"length2":30},{"diffs":[[0,"ountId) ) {\n"],[1,"      "],[0,"      if ( r"]],"start1":3964,"start2":3964,"length1":24,"length2":30},{"diffs":[[0,"    if ("],[-1," "],[0,"req.para"]],"start1":3984,"start2":3984,"length1":17,"length2":16},{"diffs":[[0,"ssion.accountId)"],[-1," "],[0,") {\n"],[1,"        "],[0,"        account."]],"start1":4058,"start2":4058,"length1":37,"length2":44},{"diffs":[[0,"true;\n      "],[1,"      "],[0,"}\n"],[1,"      "],[0,"      res.se"]],"start1":4113,"start2":4113,"length1":26,"length2":38},{"diffs":[[0,"count);\n"],[1,"    "],[0,"    });\n"],[1,"  "],[0,"  });\n}"]],"start1":4156,"start2":4156,"length1":23,"length2":29}]],"length":4185,"saved":false}
{"ts":1358110568886,"patch":[[{"diffs":[[0,"   });\n}"],[1,";"]],"start1":4177,"start2":4177,"length1":8,"length2":9}]],"length":4186,"saved":false}
